<!DOCTYPE html>
<html>
    <head>
        <!-- common head -->
        <meta charset="utf-8">
        <meta http-equiv="content-type" content="text/html">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <meta name="format-detection" content="telephone=no">
        <link rel="Shortcut Icon" href="/resources/logo_black.png">
        <title>Rainarea</title>
        <!-- Common CSS and Scripts -->
        <link href="/stylesheets/common.css" rel="stylesheet" type="text/css">
        <script type="text/javascript" src="/scripts/ajax.js"></script>
        
        <script>
            document.addEventListener("DOMContentLoaded", function (event) {
                var head = document.getElementsByTagName("head")[0];
                var body = document.getElementsByTagName("body")[0];
                var loadedJson;
                
                var loadedComponent = {},
                    loadedContent = {},
                    loadedContentCSS = [],
                    loadedContentJS = [];
                
                $ajax.sendGetRequest("index.json", function (request) {
                    loadedJson = request;
                    body.dispatchEvent($ajax.LoadedEvent);
                }, true);
                body.addEventListener("ajaxloaded", function () {
                    loadComponents();
                    loadContents();
                });
                
                var isLoadingComponents = false;
                function loadComponents () {
                    if (isLoadingComponents) {
                        window.console.log("Components> Error: Running hasn't finished");
                        return;
                    } else {
                        isLoadingComponents = true;
                        window.console.log("Components> Now Loading");
                    }
                    var addQueue = [],
                        removeQueue = [],
                        waitingHTML = [],
                        waitingJS = [],
                        count = 0;
                    //Initialize Add Queue
                    for (var i = 0; i < loadedJson.components.length; i ++) {
                        if (!loadedComponent[loadedJson.components[i]]) {
                            addQueue.push(loadedJson.components[i]);
                        }
                    }
                    window.console.log("Components> Add " + addQueue);
                    //Initialize Remove Queue
                    for (var item in loadedComponent) {
                        if (!loadedJson.components.includes(item)) {
                            removeQueue.push(item);
                        }
                    }
                    window.console.log("Components> Remove" + removeQueue);
                    //Run Add Queue
                    for (var i = 0; i < addQueue.length; i ++) {
                        var component = addQueue[i];
                        
                        var css = document.createElement("link");
                        css.href = "\/components\/" + component + "\/" + component + ".css";
                        css.type = "text/css";
                        css.rel = "stylesheet";
                        head.appendChild(css);

                        $ajax.sendGetRequest("\/components\/" + component + "\/" + component + ".html", function (request) {
                            var html = document.createElement("div");
                            html.component = addQueue[count];
                            html.id = addQueue[count];
                            html.innerHTML += request;
                            waitingHTML.push(html);
                            
                            var js = document.createElement("script");
                            js.component = addQueue[count];
                            js.src = "\/components\/" + addQueue[count] + "\/" + addQueue[count] + ".js";
                            js.type = "text/javascript";
                            waitingJS.push(js);
                            
                            count ++;
                            if (count === addQueue.length) {
                                for (var j = 0; j < addQueue.length; j ++) {
                                    for (var k = 0; k < waitingHTML.length; k ++) {
                                        if (waitingHTML[k].component === addQueue[j]) {
                                            body.appendChild(waitingHTML[k]);
                                            head.appendChild(waitingJS[k]);
                                            loadedComponent[addQueue[j]] = waitingHTML[k];
                                            window.console.log("Components> Added: " + addQueue[j])
                                        }
                                    }
                                }
                                isLoadingComponents = false;
                            }
                        });
                    }
                    //Run Remove Queue
                    for (var i = 0; i < removeQueue.length; i ++) {
                        var component = document.getElementById(removeQueue[i]);
                        component.innerHTML = "";
                        component.parentNode.removeChild(component);
                        
                        var links = document.getElementsByTagName("link");
                        for (var j = 0; j < links.length; j ++) {
                            if (links[j].component === removeQueue[i]) {
                                links[j].parentNode.removeChild(links[j]);
                            }
                        }
                        
                        var scripts = document.getElementsByTagName("script");
                        for (var j = 0; j < scripts.length; j ++) {
                            if (scripts[j].component === removeQueue[i]) {
                                scripts[j].innerHTML = "";
                                scripts[j].parentNode.removeChild(scripts[j]);
                            }
                        }
                        
                        window.console.log("Components> Removed: " + removeQueue[i])
                    }
                }
                
                
                
                function loadContents () {
                    if (isLoadingContents) {
                        window.console.log("Contents> Error: Running hasn't finished");
                        return;
                    } else {
                        var isLoadingContents = true;
                        window.console.log("Contents> Now Loading");
                    }
                    var addQueue = [],
                        removeQueue = [],
                        waitingHTML = [],
                        waitingJS = [],
                        contentJson = [],
                        wrapper = document.getElementById("content"),
                        count = 0;
                    //Initialize Add Queue
                    for (var a = 0; a < loadedJson.contents.length; a ++) {
                        if (!loadedContent[loadedJson.contents[a]]) addQueue.push(loadedJson.contents[a]);
                    }
                    window.console.log("Contents> Add: " + addQueue);
                    //Initialize Remove Queue
                    for (var item in loadedContent) {
                        if (!loadedJson.contents.includes(item)) {
                            removeQueue.push(item);
                        }
                    }
                    window.console.log("Contents> Remove: " + addQueue);
                    //Run Add Queue
                    for (var i = 0; i < loadedJson.contents.length; i ++) {
                        var content = addQueue[i];
                        $ajax.sendGetRequest("\/contents\/" + content + "\/" + content + ".json", function (request) {
                            contentJson.push(request);
                            count ++;
                            if (count === loadedJson.contents.length) {
                                count = 0;
                                for (var j = 0; j < contentJson.length; j ++) {
                                    if (contentJson[j].stylesheet !== null && !loadedContentCSS[contentJson[j].stylesheet]) {
                                        var css = document.createElement("link");
                                        css.href = contentJson[j].stylesheet;
                                        css.type = "text/css";
                                        css.rel = "stylesheet";
                                        head.appendChild(css);
                                        loadedContentCSS.push(contentJson[j].stylesheet);
                                    }
                                    $ajax.sendGetRequest("\/contents\/" + contentJson[j].name + "\/" + contentJson[j].name + ".html", function (request) {
                                        var html = document.createElement("div");
                                        html.content = addQueue[count];
                                        html.id = addQueue[count];
                                        html.innerHTML += request;
                                        waitingHTML.push(html);
                                        
                                        if (contentJson[count].script !== null && !loadedContentJS[contentJson[count].script]) {
                                            var js = document.createElement("script");
                                            js.content = addQueue[count];
                                            js.src = contentJson[count].script;
                                            js.type = "text/javascript";
                                            waitingJS.push(js);
                                        }
                                        
                                        count ++;
                                        if (count === addQueue.length) {
                                            for (var j = 0; j < addQueue.length; j ++) {
                                                for (var k = 0; k < waitingHTML.length; k ++) {
                                                    if (waitingHTML[k].content === addQueue[j]) {
                                                        wrapper.appendChild(waitingHTML[k]);
                                                        loadedContent[addQueue[j]] = waitingHTML[k];
                                                        window.console.log("Contents> Added: " + addQueue[j])
                                                    }
                                                }
                                                for (var k = 0; k < waitingJS.length; k ++) {
                                                    if (waitingHTML[k].content === addQueue[j]) {
                                                        head.appendChild(waitingJS[k]);
                                                        loadedContentCSS.push(waitingJS[k].src);
                                                    }
                                                }
                                            }
                                            isLoadingContents = false;
                                        }
                                    });
                                }
                            }
                        }, true);
                    }
                    //Run Remove Queue
                    for (var i = 0; i < removeQueue.length; i ++) {
                        var content = document.getElementById(removeQueue[i]);
                        content.innerHTML = "";
                        content.parentNode.removeChild(content);
                        
                        window.console.log("Contents> Removed: " + removeQueue[i])
                    }
                }
                function sortContents () {
                    
                }
            });
        </script>
    </head>
    <body>
        <div id="content"></div>
    </body>
</html>
